\include{settings}

\begin{document}    % начало документа

    % Титульная страница
    \include{titlepage}

    % Содержание
    \include{ToC}


    \section{Цель работы}
    Освоить механизмы структурной обработки исключений в операционной системе Windows и реализовать различные их варианты на языке С++ с помощью WinAPI.

    \section{Программа работы}
    Выполнить задания для исключений двух типов:
    \begin{itemize}
        \item Ошибка деления на ноль (EXCEPTION\_INT\_DIVIDE\_BY\_ZERO)
        \item Переполнение разряда Integer (EXCEPTION\_INT\_OVERFLOW)
    \end{itemize}

    Задания для каждого пункта:
    \begin{enumerate}
        \item Сгенерировать и обработать исключения с помощью функций WinAPI
        \item Получить код исключения с помощью функции \textbf{GetExceptionCode}.
        \begin{itemize}
            \item Использовать эту функции в выражении фильтра;
            \item Использовать ту функци в обработчике;
        \end{itemize}
        \item Создать собственную функцию-фильтр;
        \item Получить информацию об исключении с помощью функции \textbf{GetExceptionInformation}; сгенерировать исключение с помощью функции \textbf{RaiseException};
        \item Использовать функции \textbf{UnhandledExceptionFilter} и \textbf{SetUnhandledExceptionFilter} для необработанных исключений;
        \item Обработать вложенные исключения;
        \item Выйти из блока \_\_try с помощью оператора \textbf{goto};
        \item Выйти из блока \_\_try c помощью оператора \textbf{leave};
        \item Преобразовать структурное исключение в исключение языка С, используя функцию \textbf{translator};
        \item Использовать финальный обработчик \textbf{finally};
    \end{enumerate}

    Для каждого пункта представить отдельную программу.
    Специфический код, связанный с особенностями генерации заданного исключения, структурировать в отдельный элемент (функцию, макрос или иное).

    \section{Теоретическая информация}
    Исключение — это событие при выполнении программы, которое приводит к её ненормальному или неправильному поведению.
    Существует два вида исключений: аппаратные, которые генерируются процессором, и программные, генерируемые операционной системой и прикладными программами.

    В операционной системе Windows механизм обработки исключений выполняется:
    \begin{itemize}
        \item Средствами языка С++
        \item Средствами Windows — Structured Exception Handling (SEH)
    \end{itemize}
    Между данными механизмами существует ряд отличий:
    \begin{itemize}
        \item SEH пригоден как для программных, так и для аппаратных исключений в отличие от средств С++
        \item В SEH исключение — это ошибка при выполнении программы, в С++ — это объект произвольного типа. Обработчик catch может рассматриваться как функция с одним параметром, которая выполняется только при совпадении типа ее параметра с типом выброшенного исключения.
        \item По-разному раскручивается стек
    \end{itemize}
    Суть механизма SEH заключается в следующем:
    \begin{itemize}
        \item В программе выделяется блок кода — фрейм, в котором может произойти исключение (охраняемый код);
        \item За фреймом размещается блок обработчика;
        \item Далее размещается первая инструкция, исполняемая после выполнения обработчика.
    \end{itemize}
    Механизм SEH поддерживается Microsoft только на уровне компилятора с помощью реализации нестандартных синтаксических конструкций \_\_try, \_\_except и \_\_finally.
    Ключевое слово \_\_try используется для выделения участка кода, в котором генерация исключения будет обработана одним или несколькими блоками \_\_except.
    Код, находящийся в блоке \_\_finally, выполнится всегда и независимо от других блоков \_\_try и \_\_except

    \begin{lstlisting}[caption=Пример использования с языке С/С++]
        __try {
        // защищенный код,
        // который помещается в SEH-фрейм
        }
        __except (фильтр исключений) {
        // обработчик исключений
        }
        __finally {
        // выполняющийся в любом случае код
        }
    \end{lstlisting}

    В качестве фильтра исключений могут выступать обычные функции, возвращающие три константных выражения:
    \begin{enumerate}
        \item EXCEPTION\_EXECUTE\_HANDLER — указывает на возможность данного обработчика обработать исключение. При получении такого значения операционная система прекращает поиск релевантных обработчиков исключения и, выполнив раскрутку стека, передаёт управление первому обработчику, вернувшему значение;
        \item EXCEPTION\_CONTINUE\_EXECUTION — указывает на исправление ошибки. Система снова передаст управление на инструкцию, которая вызвала исключение, поскольку предполагается, что в этот раз она не вызовет исключение;
        \item EXCEPTION\_CONTINUE\_SEARCH — указывает, что подходящий обработчик может быть найден выше по стеку. В то же время возвращение этого значения может быть свидетельством того, что ошибка не обработана.
    \end{enumerate}

    \section{WinDbg}
    Отладка — это процесс поиска и устранения дефектов или проблем в компьютерной программе, которые мешают правильной работе программного обеспечения или системы.
    В данной работе для изучения особенностей исключений использовался отладчик WinDbg.
    WinDbg — это многоцелевой отладчик для Microsoft Windows ОС, распространяемый Microsoft.
    Его можно использовать для отладки приложений пользовательского режима, драйверов устройств и самой операционной системы в режиме ядра.
    WinDbg может использоваться для отладки дампов памяти в режиме ядра, созданных после того, что обычно называют «синим экраном смерти», возникающим при выполнении проверки на наличие ошибок.
    Его также можно использовать для отладки аварийных дампов в пользовательском режиме.
    WinDbg может автоматически загружать файлы отладочных символов (например, файлы PDB) с сервера, сопоставляя различные критерии (например, временную метку, CRC, одиночную или многопроцессорную версию) через SymSrv (SymSrv.dll).
    Последние версии WinDbg были и распространяются как часть бесплатного комплекта средств отладки для Windows, который имеет общий отладочный интерфейс между WinDbg и внешними интерфейсами отладчика командной строки, такими как KD, CDB и NTSD.
    Большинство команд можно использовать как есть со всеми включенными интерфейсами отладчика.

    WinDbg имеет следующие команды и операции, отвечающие за контроль исполнения процесса отладки и анализа кода на наличие ошибок:
    \begin{enumerate}
        \item g – продолжить выполнение;
        \item p – шаг через функцию;
        \item t – шаг внутрь функции;
        \item pa addr – шаг в адрес;
        \item pc – шаг в следующий вызов;
        \item pt – шаг к следующему возврату;
        \item pct – шаг к следующему вызову или возврату;
        \item bp – установка точки останова, например bp nt!NtCreateFile;
        \item bl – список точек останова;
        \item bd – <число> убрать точку останову под номером;
        \item bc – <число> очистить точку останова под номером;
        \item ba – точка останова на доступ;
        \item be – точка останова на исполнение;
        \item be – точка останова на исполнение;
        \item bw – точка останова на запись;
        \item sxe ld:kernel32 – точка останова на загрузке DLL модуля;
    \end{enumerate}
    \section{Ход выполнения работы}

    \include{part1}
    \include{part2}
    \section{Выводы}
    В ходе данной работы были изучены принципы структурной обработки исключений (SEH) с использованием специальных методов и средств, предоставляемых библиотекой WinAPI. При помощи средства отладки WinDbg были исследованы системные процессы, происходящие при генерации и обработке исключений. Несмотря на то, что SEH и исключения в языке C++, на первый взгляд, могут показаться идентичными, они сильно отличаются друг от друга.
    Их совместное применение требует внимательного обращения, поскольку обработчики исключений, написанные пользователем и сгенерированные C++, могут взаимодействовать между собой и приводить к нежелательным последствиям. Например, обработчики исключений Windows не осуществляют вызов деструкторов, что в ряде случаев необходимо для уничтожения объектов С++. Документация Microsoft рекомендует полностью отказаться от использования обработчиков Windows в прикладных программах на С++ и ограничиться применением в них только обработчиков исключений С++

    \begin{thebibliography}{00}
        \bibitem{b1} WinDbg, URL https://en.wikipedia.org/wiki/WinDbg;
        \bibitem{b2} Wikipedia, Interger Overflow Flags, URL: https://en.wikipedia.org/wiki/Integer\_overflow
        \bibitem{b3} Intel Developer Zone: How best to handle integer overflow situations, URL: https://software.intel.com/en-us/forums/intel-fortran-compiler/topic/731539
    \end{thebibliography}
\end{document}
